{% comment %}
This file was initially used to provide access to GitHub variables
available when rendering websites through GitHub Pages.
It has since then been expanded to also work with GitLab Pages,
although with some limitations due to platform differences.
Particularly, the variable "repo_info" is set to false when rendering
through GitLab Pages. The value false is the same set by github-pages
plugin when GitHub's API cannot be reached.

When rendering websites locally, `site.github.url` doesn't get resolved properly
unless a GitHub Personal Access Token is set up and available in the
environment. This leads to warnings and errors when trying to serve the site
locally. To work around this, we use the `jekyll.environment` variable which is
set to `development` when rendering the site locally, and set to `production` on
GitHub where `site.github.url` is defined.
{% endcomment %}

{% if site.env.GITLAB_CI %}

{% comment %}
This block applies when running in a GitLab CI environment
See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
for GitLab CI specific variables.
{% endcomment %}

{% assign repo_name = site.env.CI_PROJECT_NAME %}
{% assign repo_info = false %}
{% assign default_branch = site.env.CI_DEFAULT_BRANCH %}
{% assign repo_url = site.env.CI_REPOSITORY_URL %}
{% assign search_domain_url = site.env.CI_PAGES_URL %}
{% assign project_title = site.env.CI_PROJECT_TITLE %}
{% assign source_branch = site.env.CI_MERGE_REQUEST_SOURCE_BRANCH_NAME %}

{% elsif jekyll.environment == "production" and site.github %}

{% comment %}
First, get the name of the repository
{% endcomment %}
{% assign repo_name = site.github.repository_name %}

{% comment %}
`site.github.public_repositories` contains comprehensive information for all public repositories for the organization. We use `where` to extract the part
of the metadata that is relevant to the present repository.
{% endcomment %}
{% assign repo_info = site.github.public_repositories | where: "name", repo_name %}

{% comment %}
Now, we can extract the default branch for the repo
{% endcomment %}
{% assign default_branch = repo_info[0].default_branch %}

{% comment %}
Other variables requested by the template
{% endcomment %}
{% assign repo_url = site.github.repository_url %}
{% assign search_domain_url = site.github.url %}
{% assign project_title = site.github.project_title %}
{% assign source_branch = site.github.source.branch %}

{% elsif jekyll.environment == "development" %}

{% assign repo_name = "" %}
{% assign repo_url = "" %}
{% assign default_branch = "" %}
{% assign search_domain_url = "" %}
{% assign project_title = "" %}
{% assign source_branch = "" %}

{% endif %}
